{"ast":null,"code":"import { Contract, BigNumber } from 'ethers';\nimport IERC20ABI from './abis/IERC20.json';\nimport SmartTokenABI from './abis/SmartToken.json';\nconst options = {\n  gasLimit: 286750\n};\nlet decimals = BigNumber.from(18);\ndecimals = BigNumber.from(10).pow(decimals);\nexport const getNetwork = chainId => {\n  let network;\n\n  switch (chainId) {\n    case 1:\n      network = 'Mainnet';\n      break;\n\n    case 3:\n      network = 'Ropsten';\n      break;\n\n    case 4:\n      network = 'Rinkeby';\n      break;\n\n    case 5:\n      network = 'Goerli';\n      break;\n\n    case 42:\n      network = 'Kovan';\n      break;\n\n    default:\n      network = '';\n  }\n\n  return network;\n};\nexport const SmartTokenContract = user => {\n  var _user$library;\n\n  const network = getNetwork(user.chainId);\n  const contract = new Contract(SMART_TOKEN_ADDRESSES[network], SmartTokenABI.abi, (_user$library = user.library) === null || _user$library === void 0 ? void 0 : _user$library.getSigner());\n  return contract;\n};\n_c = SmartTokenContract;\nexport const daiContract = user => {\n  var _user$library2;\n\n  const network = getNetwork(user.chainId);\n  const contract = new Contract(DAI_ADDRESSES[network], IERC20ABI.abi, (_user$library2 = user.library) === null || _user$library2 === void 0 ? void 0 : _user$library2.getSigner());\n  return contract;\n};\nexport const getTOKBalance = async user => {\n  const contract = SmartTokenContract(user);\n  const balance = await contract.balanceOf(user.account);\n  return balance;\n};\nexport const getDAIBalance = async user => {\n  const contract = daiContract(user);\n  const balance = await contract.balanceOf(user.account);\n  return balance;\n};\nexport const getBuyPrice = async (user, amount, supply) => {\n  const contract = SmartTokenContract(user);\n  const buyPrice = await contract.calculatePurchaseReturn(supply, amount);\n  return buyPrice;\n};\nexport const userCanBuy = async (user, amount, totalSupply, setMessage) => {\n  const dai = daiContract(user);\n  const network = getNetwork(user.chainId);\n  const allowance = await dai.allowance(user.account, SMART_TOKEN_ADDRESSES[network]);\n  const daiBal = await getDAIBalance(user);\n  const realDailBal = parseInt(daiBal.div(decimals).toString(), 10);\n  const buyPrice = await getBuyPrice(user, amount, totalSupply);\n  const realBuyPrice = parseInt(buyPrice.toString(), 10);\n\n  if (realDailBal < realBuyPrice) {\n    setMessage(`Your DAI balance is insufficient for this order.`);\n    return false;\n  }\n\n  if (allowance.div(decimals) < buyPrice) {\n    setMessage(`Set allowance for ${buyPrice} DAI to continue order.`);\n    return false;\n  }\n\n  return true;\n};\nexport const buy = async (user, amount) => {\n  const contract = SmartTokenContract(user);\n  const tx = await contract.buy(amount, options);\n  return tx.hash;\n};\nexport const initateBuy = async (user, amount, setMessage) => {\n  let hash;\n  const contract = SmartTokenContract(user);\n  const totalSupply = await contract.totalSupply();\n  const bnAmount = BigNumber.from(amount).mul(decimals);\n  const canBuy = await userCanBuy(user, amount, totalSupply.div(decimals), setMessage);\n\n  if (canBuy) {\n    hash = await buy(user, bnAmount);\n  }\n\n  return hash;\n};\nexport const approve = async (user, amount) => {\n  const network = getNetwork(user.chainId);\n  const dai = daiContract(user);\n  const tx = await dai.approve(SMART_TOKEN_ADDRESSES[network], amount, options);\n  return tx.hash;\n};\nexport const initiateSell = async (user, amount, setMessage) => {\n  const contract = SmartTokenContract(user);\n  let balance = await contract.balanceOf(user.account);\n  balance = parseInt(balance.div(decimals).toString(), 10);\n\n  if (balance < parseInt(amount.toString(), 10)) {\n    setMessage(`Your TOK balance is insufficient for this order.`);\n    return false;\n  }\n\n  const sellAmount = BigNumber.from(amount).mul(decimals);\n  const tx = await contract.sell(sellAmount);\n  return tx.hash;\n};\n\nvar _c;\n\n$RefreshReg$(_c, \"SmartTokenContract\");","map":{"version":3,"sources":["/Users/kifen/Dev/interview-test/StakePool/packages/frontend/src/services/utils.ts"],"names":["Contract","BigNumber","IERC20ABI","SmartTokenABI","options","gasLimit","decimals","from","pow","getNetwork","chainId","network","SmartTokenContract","user","contract","SMART_TOKEN_ADDRESSES","abi","library","getSigner","daiContract","DAI_ADDRESSES","getTOKBalance","balance","balanceOf","account","getDAIBalance","getBuyPrice","amount","supply","buyPrice","calculatePurchaseReturn","userCanBuy","totalSupply","setMessage","dai","allowance","daiBal","realDailBal","parseInt","div","toString","realBuyPrice","buy","tx","hash","initateBuy","bnAmount","mul","canBuy","approve","initiateSell","sellAmount","sell"],"mappings":"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","sourcesContent":["import { Contract, BigNumber } from 'ethers'\nimport IERC20ABI from './abis/IERC20.json'\nimport SmartTokenABI from './abis/SmartToken.json'\nimport { MANA_POOL, xMANA_ADDRESS } from './constants'\nimport { User } from './types'\n\nconst options = { gasLimit: 286750 }\nlet decimals = BigNumber.from(18)\ndecimals = BigNumber.from(10).pow(decimals)\n\nexport const getNetwork = (chainId?: number): string => {\n  let network: string\n\n  switch (chainId) {\n    case 1:\n      network = 'Mainnet'\n      break\n    case 3:\n      network = 'Ropsten'\n      break\n    case 4:\n      network = 'Rinkeby'\n      break\n    case 5:\n      network = 'Goerli'\n      break\n    case 42:\n      network = 'Kovan'\n      break\n    default:\n      network = ''\n  }\n\n  return network\n}\n\nexport const SmartTokenContract = (user: User): Contract => {\n  const network: any = getNetwork(user.chainId)\n  const contract = new Contract(\n    SMART_TOKEN_ADDRESSES[network],\n    SmartTokenABI.abi,\n    user.library?.getSigner(),\n  )\n\n  return contract\n}\n\nexport const daiContract = (user: User): Contract => {\n  const network: any = getNetwork(user.chainId)\n  const contract = new Contract(\n    DAI_ADDRESSES[network],\n    IERC20ABI.abi,\n    user.library?.getSigner(),\n  )\n\n  return contract\n}\n\nexport const getTOKBalance = async (user: User): Promise<BigNumber> => {\n  const contract = SmartTokenContract(user)\n  const balance = await contract.balanceOf(user.account)\n  return balance\n}\n\nexport const getDAIBalance = async (user: User): Promise<BigNumber> => {\n  const contract = daiContract(user)\n  const balance = await contract.balanceOf(user.account)\n  return balance\n}\n\nexport const getBuyPrice = async (\n  user: User,\n  amount: BigNumber,\n  supply: BigNumber,\n): Promise<number> => {\n  const contract = SmartTokenContract(user)\n  const buyPrice = await contract.calculatePurchaseReturn(supply, amount)\n  return buyPrice\n}\n\nexport const userCanBuy = async (\n  user: User,\n  amount: BigNumber,\n  totalSupply: BigNumber,\n  setMessage: (arg0: string) => void,\n): Promise<boolean> => {\n  const dai = daiContract(user)\n  const network: any = getNetwork(user.chainId)\n  const allowance = await dai.allowance(\n    user.account,\n    SMART_TOKEN_ADDRESSES[network],\n  )\n  const daiBal = await getDAIBalance(user)\n  const realDailBal = parseInt(daiBal.div(decimals).toString(), 10)\n\n  const buyPrice = await getBuyPrice(user, amount, totalSupply)\n  const realBuyPrice = parseInt(buyPrice.toString(), 10)\n\n  if (realDailBal < realBuyPrice) {\n    setMessage(`Your DAI balance is insufficient for this order.`)\n    return false\n  }\n\n  if (allowance.div(decimals) < buyPrice) {\n    setMessage(`Set allowance for ${buyPrice} DAI to continue order.`)\n    return false\n  }\n\n  return true\n}\n\nexport const buy = async (user: User, amount: BigNumber): Promise<string> => {\n  const contract = SmartTokenContract(user)\n  const tx = await contract.buy(amount, options)\n  return tx.hash\n}\n\nexport const initateBuy = async (\n  user: User,\n  amount: BigNumber,\n  setMessage: (arg0: string) => void,\n) => {\n  let hash\n  const contract = SmartTokenContract(user)\n  const totalSupply = await contract.totalSupply()\n  const bnAmount = BigNumber.from(amount).mul(decimals)\n  const canBuy = await userCanBuy(\n    user,\n    amount,\n    totalSupply.div(decimals),\n    setMessage,\n  )\n\n  if (canBuy) {\n    hash = await buy(user, bnAmount)\n  }\n\n  return hash\n}\n\nexport const approve = async (user: User, amount: BigNumber) => {\n  const network: any = getNetwork(user.chainId)\n\n  const dai = daiContract(user)\n  const tx = await dai.approve(SMART_TOKEN_ADDRESSES[network], amount, options)\n  return tx.hash\n}\n\nexport const initiateSell = async (\n  user: User,\n  amount: BigNumber,\n  setMessage: (arg0: string) => void,\n) => {\n  const contract = SmartTokenContract(user)\n  let balance = await contract.balanceOf(user.account)\n  balance = parseInt(balance.div(decimals).toString(), 10)\n\n  if (balance < parseInt(amount.toString(), 10)) {\n    setMessage(`Your TOK balance is insufficient for this order.`)\n    return false\n  }\n  const sellAmount = BigNumber.from(amount).mul(decimals)\n  const tx = await contract.sell(sellAmount)\n  return tx.hash\n}\n"]},"metadata":{},"sourceType":"module"}